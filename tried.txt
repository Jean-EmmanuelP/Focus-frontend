# ANALYSE COMPLETE - SYNCHRONISATION GOOGLE CALENDAR (Tasks uniquement)

================================================================================
## ETAT ACTUEL APRES SUPPRESSION SYNC ROUTINES
================================================================================

La synchronisation Google Calendar ne concerne maintenant que les **TASKS**.
Les routines restent locales √† Volta uniquement.

### Fichiers impliqu√©s:
- `internal/googlecalendar/handler.go` - Toute la logique sync
- `internal/calendar/handler.go` - Appelle les fonctions sync lors de CRUD tasks
- `cmd/api/main.go` - Connecte calendarHandler au googleCalendarHandler

### Fonctions de sync actives:
1. `SyncTaskToGoogleCalendar()` - Sync une task Focus ‚Üí Google
2. `DeleteGoogleCalendarEvent()` - Supprime un event Google
3. `SyncAllTasksToGoogleCalendar()` - Sync toutes les tasks futures
4. `syncTasksToGoogle()` - Sync batch (tasks modifi√©es depuis dernier sync)
5. `importEventsFromGoogle()` - Import Google ‚Üí Focus

================================================================================
## TOUS LES SCENARIOS - FOCUS ‚Üí GOOGLE CALENDAR
================================================================================

### Sc√©nario 1: CR√âATION d'une task dans Focus
**D√©clencheur:** POST /calendar/tasks
**Flux:**
1. Task cr√©√©e dans DB (sans google_event_id)
2. Goroutine async appelle `SyncTaskToGoogleCalendar()`
3. V√©rifie: config existe, is_enabled, sync_direction (bidirectional/to_google)
4. V√©rifie: token non expir√©
5. `SELECT google_event_id FROM tasks WHERE id = $1` ‚Üí NULL
6. POST vers Google Calendar API ‚Üí cr√©e event
7. UPDATE tasks SET google_event_id, google_calendar_id, last_synced_at

**‚úÖ R√©sultat:** Task cr√©√©e dans Focus ET event cr√©√© dans Google
**‚ö†Ô∏è Risque:** Si goroutine √©choue, task existe sans event Google (orphelin c√¥t√© Focus)

---

### Sc√©nario 2: MODIFICATION d'une task dans Focus
**D√©clencheur:** PATCH /calendar/tasks/{id}
**Flux:**
1. Task modifi√©e dans DB
2. Goroutine async appelle `SyncTaskToGoogleCalendar()`
3. `SELECT google_event_id FROM tasks WHERE id = $1` ‚Üí "abc123"
4. PATCH vers Google Calendar API avec l'ID existant
5. UPDATE tasks SET last_synced_at = now()

**‚úÖ R√©sultat:** Modifications propag√©es vers Google Calendar
**‚úÖ Pas de doublon:** Utilise l'ID existant pour PATCH

---

### Sc√©nario 3: SUPPRESSION d'une task dans Focus
**D√©clencheur:** DELETE /calendar/tasks/{id}
**Flux:**
1. `SELECT google_event_id FROM tasks WHERE id = $1` AVANT suppression
2. DELETE FROM tasks WHERE id = $1
3. SI google_event_id existe: goroutine async appelle `DeleteGoogleCalendarEvent()`
4. DELETE vers Google Calendar API

**‚úÖ R√©sultat:** Task supprim√©e de Focus ET event supprim√© de Google
**‚úÖ G√®re 404:** Si event d√©j√† supprim√© c√¥t√© Google, pas d'erreur

---

### Sc√©nario 4: SYNC MANUELLE (bouton "Sync Now")
**D√©clencheur:** POST /google-calendar/sync
**Flux:**
1. Appelle `performSync()` qui:
   - `syncTasksToGoogle()`: Tasks o√π google_event_id IS NULL OR last_synced_at < updated_at
   - `importEventsFromGoogle()`: Importe events des 30 prochains jours

**‚úÖ R√©sultat:** Sync bidirectionnelle compl√®te
**‚ö†Ô∏è Limite:** Maximum 50 tasks synced, 100 events import√©s par appel

---

### Sc√©nario 5: CONNEXION INITIALE (apr√®s OAuth)
**D√©clencheur:** POST /google-calendar/tokens
**Flux:**
1. Sauvegarde access_token, refresh_token, token_expiry
2. Goroutine async appelle `SyncAllTasksToGoogleCalendar()`
3. Sync toutes les tasks futures (date >= CURRENT_DATE)

**‚úÖ R√©sultat:** Toutes les tasks existantes sont pouss√©es vers Google

================================================================================
## TOUS LES SCENARIOS - GOOGLE CALENDAR ‚Üí FOCUS
================================================================================

### Sc√©nario 6: CR√âATION d'un event dans Google Calendar
**D√©clencheur:** POST /google-calendar/sync (manuel)
**Flux:**
1. Fetch events des 30 prochains jours depuis Google
2. Pour chaque event:
   - Skip si summary vide
   - Skip si commence par "üîÑ" (ancien pr√©fixe routine)
3. `SELECT id FROM tasks WHERE google_event_id = $1` ‚Üí pas trouv√©
4. INSERT INTO tasks avec google_event_id

**‚úÖ R√©sultat:** Nouvel event Google devient task dans Focus
**‚ö†Ô∏è Pas automatique:** N√©cessite sync manuelle

---

### Sc√©nario 7: MODIFICATION d'un event dans Google Calendar
**D√©clencheur:** POST /google-calendar/sync (manuel)
**Flux:**
1. `SELECT id, updated_at FROM tasks WHERE google_event_id = $1` ‚Üí trouv√©
2. Compare timestamps: `googleUpdated.After(existingUpdatedAt)`
3. SI Google plus r√©cent: UPDATE tasks SET title, description, date, scheduled_start, scheduled_end

**‚úÖ R√©sultat:** Modifications Google propag√©es vers Focus (si Google plus r√©cent)
**‚úÖ Gestion conflits:** Google gagne si plus r√©cent

---

### Sc√©nario 8: SUPPRESSION d'un event dans Google Calendar
**D√©clencheur:** POST /google-calendar/sync (manuel)
**Flux:**
1. Google retourne event avec status="cancelled"
2. `DELETE FROM tasks WHERE user_id = $1 AND google_event_id = $2`

**‚úÖ R√©sultat:** Task supprim√©e de Focus

---

### Sc√©nario 9: Event all-day dans Google Calendar
**Flux:**
1. event.Start.Date existe mais event.Start.DateTime est vide
2. Utilise event.Start.Date directement comme eventDate
3. scheduled_start et scheduled_end restent NULL

**‚úÖ R√©sultat:** Task cr√©√©e sans heures (all-day)

================================================================================
## SCENARIOS DE RACE CONDITION
================================================================================

### Sc√©nario 10: DOUBLE CR√âATION RAPIDE (m√™me task)
**Situation:** Appui rapide 2x sur "Cr√©er" ou latence r√©seau
**Flux potentiel:**
```
T1: Goroutine 1 ‚Üí SELECT google_event_id ‚Üí NULL
T2: Goroutine 2 ‚Üí SELECT google_event_id ‚Üí NULL (pas encore sauv√©!)
T3: Goroutine 1 ‚Üí POST ‚Üí cr√©e event A
T4: Goroutine 2 ‚Üí POST ‚Üí cr√©e event B (DOUBLON!)
T5: Goroutine 1 ‚Üí UPDATE SET google_event_id = A
T6: Goroutine 2 ‚Üí UPDATE SET google_event_id = B (√©crase A!)
```

**‚ö†Ô∏è PROBL√àME:**
- 2 events cr√©√©s dans Google Calendar
- Event A devient orphelin (non track√©)
- Seul event B est r√©f√©renc√©

**Probabilit√©:** Faible (n√©cessite timing pr√©cis)
**Impact:** Events orphelins dans Google Calendar

---

### Sc√©nario 11: MODIFICATION + SYNC BATCH en parall√®le
**Situation:** User modifie task pendant qu'un sync batch tourne
**Flux potentiel:**
1. Sync batch lit task avec ancien titre "A"
2. User modifie titre en "B", d√©clenche goroutine
3. Goroutine sync "B" vers Google
4. Sync batch sync "A" vers Google (√©crase "B")

**‚ö†Ô∏è PROBL√àME:** Donn√©es incoh√©rentes temporaires
**R√©solution:** La prochaine modification ou sync corrigera

---

### Sc√©nario 12: SUPPRESSION pendant SYNC en cours
**Situation:** User supprime task pendant que sync cr√©e l'event
**Flux potentiel:**
1. CreateTask ‚Üí goroutine d√©marre pour sync
2. User supprime imm√©diatement la task
3. Task supprim√©e de DB
4. Goroutine tente UPDATE SET google_event_id ‚Üí √©chec silencieux
5. Event cr√©√© dans Google mais task n'existe plus

**‚ö†Ô∏è PROBL√àME:** Event orphelin dans Google Calendar

================================================================================
## PROBLEMES CRITIQUES IDENTIFIES
================================================================================

### üî¥ 1. TOKEN REFRESH NON IMPL√âMENT√â
**Fichier:** googlecalendar/handler.go:812-816
```go
if time.Now().After(config.TokenExpiry) {
    log.Printf("[SyncTaskToGoogleCalendar] Token expired for user %s", userID)
    return nil // Don't fail the task creation, just skip sync
}
```

**Impact:**
- Token Google expire apr√®s ~1 heure
- Aucun refresh automatique
- Sync arr√™te silencieusement de fonctionner
- User ne sait pas que sync est cass√©e

**Solution requise:** Utiliser refresh_token pour obtenir nouveau access_token

---

### üî¥ 2. TASKS PRIV√âES SYNCHRONIS√âES
**Fichier:** Le champ `is_private` existe dans tasks mais n'est PAS v√©rifi√©

**Code manquant dans SyncTaskToGoogleCalendar:**
```go
// NE V√âRIFIE PAS is_private AVANT DE SYNC
```

**Impact:** Tasks marqu√©es "priv√©es" sont visibles dans Google Calendar partag√©

---

### üî¥ 3. PAS DE RETRY LOGIC
**Situation:** Erreur r√©seau ou API ‚Üí sync √©choue d√©finitivement

**Impact:**
- Task cr√©√©e dans Focus sans event Google
- Pas de file d'attente de retry
- Erreur juste logg√©e

---

### üü° 4. LIMITE PAGINATION
**syncTasksToGoogle:** LIMIT 50
**importEventsFromGoogle:** maxResults=100

**Impact:** Calendriers charg√©s ne sync pas compl√®tement en une fois

---

### üü° 5. PAS DE PUSH NOTIFICATIONS
**Situation:** Changements dans Google Calendar n√©cessitent sync manuelle

**Impact:** Sync pas temps r√©el, uniquement par polling/manuel

================================================================================
## VERIFICATION FONCTIONNELLE
================================================================================

| # | Sc√©nario | Direction | Statut | Notes |
|---|----------|-----------|--------|-------|
| 1 | Cr√©er task | Focus‚ÜíGoogle | ‚úÖ | Async via goroutine |
| 2 | Modifier task | Focus‚ÜíGoogle | ‚úÖ | PATCH avec event ID existant |
| 3 | Supprimer task | Focus‚ÜíGoogle | ‚úÖ | DELETE event |
| 4 | Cr√©er event Google | Google‚ÜíFocus | ‚úÖ | Sur sync manuelle |
| 5 | Modifier event Google | Google‚ÜíFocus | ‚úÖ | Si Google plus r√©cent |
| 6 | Supprimer event Google | Google‚ÜíFocus | ‚úÖ | status=cancelled |
| 7 | Event all-day | Google‚ÜíFocus | ‚úÖ | Parse date sans heure |
| 8 | Task sans heures | Focus‚ÜíGoogle | ‚úÖ | D√©faut 09:00-10:00 |
| 9 | Sync direction to_google | Focus‚ÜíGoogle | ‚úÖ | Skip import |
| 10 | Sync direction from_google | Google‚ÜíFocus | ‚úÖ | Skip export |
| 11 | Token expir√© | Tous | ‚ö†Ô∏è | Sync silencieusement ignor√©e |
| 12 | Task priv√©e | Focus‚ÜíGoogle | ‚ö†Ô∏è | Sync quand m√™me (bug) |
| 13 | Double cr√©ation rapide | Focus‚ÜíGoogle | ‚ö†Ô∏è | Doublon possible |
| 14 | Event routine üîÑ | Google‚ÜíFocus | ‚úÖ | Skip (ne cr√©e pas de task) |

================================================================================
## CONCLUSION
================================================================================

### Ce qui fonctionne bien ‚úÖ
1. Sync bidirectionnelle basique pour les tasks
2. Gestion des conflits (Google gagne si plus r√©cent)
3. Suppression propag√©e dans les deux sens
4. Events all-day correctement g√©r√©s
5. Routines correctement exclues de la sync

### Ce qui doit √™tre corrig√© üî¥
1. **Token refresh** - CRITIQUE - sync casse apr√®s 1h
2. **Tasks priv√©es** - Ne pas sync les tasks is_private=true
3. **Retry logic** - R√©essayer les sync √©chou√©es

### Am√©liorations futures üü°
1. Pagination pour gros calendriers (>100 events)
2. Webhook Google pour sync temps r√©el
3. Notification utilisateur en cas d'erreur sync
4. Mutex/transaction pour √©viter race conditions

================================================================================
## RECOMMANDATION FINALE
================================================================================

La synchronisation Google Calendar pour les tasks est **FONCTIONNELLE** pour un usage normal.

**Risques acceptables:**
- Race condition (probabilit√© faible, impact faible)
- Limite 100 events (peu d'utilisateurs concern√©s)

**√Ä corriger avant production stable:**
1. ‚ö†Ô∏è Token refresh automatique
2. ‚ö†Ô∏è Exclure tasks priv√©es de la sync

Le code actuel peut √™tre utilis√© en l'√©tat avec la connaissance que:
- Le token expire apr√®s 1h et n√©cessite reconnexion Google
- Les tasks priv√©es appara√Ætront dans Google Calendar
